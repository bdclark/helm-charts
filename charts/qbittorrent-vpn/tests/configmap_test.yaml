suite: test configmap
templates:
  - configmap.yaml
tests:
  - it: should not create configmap when bootstrap disabled
    asserts:
      - hasDocuments:
          count: 0

  - it: should create bootstrap configmap when enabled
    set:
      qbittorrent.config.bootstrap.enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ConfigMap
      - equal:
          path: metadata.name
          value: RELEASE-NAME-qbittorrent-vpn-bootstrap

  - it: should not create configmap when using existing configMap
    set:
      qbittorrent.config.bootstrap.enabled: true
      qbittorrent.config.bootstrap.existingConfig.type: configMap
      qbittorrent.config.bootstrap.existingConfig.name: my-config
    asserts:
      - hasDocuments:
          count: 0

  - it: should not create configmap when using existing secret
    set:
      qbittorrent.config.bootstrap.enabled: true
      qbittorrent.config.bootstrap.existingConfig.type: secret
      qbittorrent.config.bootstrap.existingConfig.name: my-secret
    asserts:
      - hasDocuments:
          count: 0

  - it: should include qBittorrent.conf key
    set:
      qbittorrent.config.bootstrap.enabled: true
    asserts:
      - isNotNull:
          path: data["qBittorrent.conf"]

  - it: should include default config content
    set:
      qbittorrent.config.bootstrap.enabled: true
    asserts:
      - matchRegex:
          path: data["qBittorrent.conf"]
          pattern: "\\[LegalNotice\\]"
      - matchRegex:
          path: data["qBittorrent.conf"]
          pattern: "\\[Preferences\\]"

  - it: should use custom config content
    set:
      qbittorrent.config.bootstrap.enabled: true
      qbittorrent.config.bootstrap.config: |
        [CustomSection]
        CustomKey=CustomValue
    asserts:
      - matchRegex:
          path: data["qBittorrent.conf"]
          pattern: "\\[CustomSection\\]"
      - matchRegex:
          path: data["qBittorrent.conf"]
          pattern: "CustomKey=CustomValue"
