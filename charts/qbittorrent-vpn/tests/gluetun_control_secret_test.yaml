suite: test gluetun control server secret
templates:
  - gluetun-control-secret.yaml
tests:
  - it: should not create secret when controlServer disabled
    asserts:
      - hasDocuments:
          count: 0

  - it: should not create secret when controlServer enabled but no inline config
    set:
      gluetun.controlServer.enabled: true
    asserts:
      - hasDocuments:
          count: 0

  - it: should not create secret when using existingSecret
    set:
      gluetun.controlServer.enabled: true
      gluetun.controlServer.existingSecret.name: my-auth-secret
      gluetun.controlServer.config: |
        [[roles]]
        name = "test"
    asserts:
      - hasDocuments:
          count: 0

  - it: should not create secret when gluetun disabled
    set:
      gluetun.enabled: false
      gluetun.controlServer.enabled: true
      gluetun.controlServer.config: |
        [[roles]]
        name = "test"
    asserts:
      - hasDocuments:
          count: 0

  - it: should create secret when controlServer enabled with inline config
    set:
      gluetun.controlServer.enabled: true
      gluetun.controlServer.config: |
        [[roles]]
        name = "qbittorrent"
        routes = ["GET /v1/portforward"]
        auth = "apikey"
        apikey = "test-key"
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: RELEASE-NAME-qbittorrent-vpn-gluetun-control-auth
      - equal:
          path: type
          value: Opaque

  - it: should use default fileName as key
    set:
      gluetun.controlServer.enabled: true
      gluetun.controlServer.config: |
        [[roles]]
        name = "test"
    asserts:
      - isNotNull:
          path: stringData["config.toml"]

  - it: should use custom fileName as key
    set:
      gluetun.controlServer.enabled: true
      gluetun.controlServer.fileName: auth.toml
      gluetun.controlServer.config: |
        [[roles]]
        name = "test"
    asserts:
      - isNotNull:
          path: stringData["auth.toml"]

  - it: should include config content
    set:
      gluetun.controlServer.enabled: true
      gluetun.controlServer.config: |
        [[roles]]
        name = "qbittorrent"
        routes = ["GET /v1/portforward"]
        auth = "apikey"
        apikey = "my-secret-key"
    asserts:
      - matchRegex:
          path: stringData["config.toml"]
          pattern: "\\[\\[roles\\]\\]"
      - matchRegex:
          path: stringData["config.toml"]
          pattern: 'name = "qbittorrent"'
      - matchRegex:
          path: stringData["config.toml"]
          pattern: 'auth = "apikey"'

  - it: should include standard labels
    set:
      gluetun.controlServer.enabled: true
      gluetun.controlServer.config: |
        [[roles]]
        name = "test"
    asserts:
      - isNotNull:
          path: metadata.labels["app.kubernetes.io/name"]
      - isNotNull:
          path: metadata.labels["helm.sh/chart"]
