suite: test pvc
templates:
  - pvc.yaml
tests:
  - it: should not create pvc by default
    asserts:
      - hasDocuments:
          count: 0

  - it: should not create pvc when using existing claim
    set:
      persistence.enabled: true
      persistence.existingClaim: my-existing-pvc
    asserts:
      - hasDocuments:
          count: 0

  - it: should create pvc when persistence enabled
    set:
      persistence.enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: PersistentVolumeClaim
      - equal:
          path: metadata.name
          value: RELEASE-NAME-mosquitto-data

  - it: should use correct access modes
    set:
      persistence.enabled: true
      persistence.accessModes:
        - ReadWriteOnce
        - ReadOnlyMany
    asserts:
      - contains:
          path: spec.accessModes
          content: ReadWriteOnce
      - contains:
          path: spec.accessModes
          content: ReadOnlyMany

  - it: should use correct size
    set:
      persistence.enabled: true
      persistence.size: 5Gi
    asserts:
      - equal:
          path: spec.resources.requests.storage
          value: 5Gi

  - it: should use storage class
    set:
      persistence.enabled: true
      persistence.storageClass: fast-ssd
    asserts:
      - equal:
          path: spec.storageClassName
          value: fast-ssd

  - it: should disable storage class when set to dash
    set:
      persistence.enabled: true
      persistence.storageClass: "-"
    asserts:
      - equal:
          path: spec.storageClassName
          value: ""

  - it: should omit storage class when empty
    set:
      persistence.enabled: true
      persistence.storageClass: ""
    asserts:
      - isNull:
          path: spec.storageClassName

  - it: should apply annotations when specified
    set:
      persistence.enabled: true
      persistence.annotations:
        custom.annotation: "test-value"
        storage.annotation: "production"
    asserts:
      - equal:
          path: metadata.annotations["custom.annotation"]
          value: "test-value"
      - equal:
          path: metadata.annotations["storage.annotation"]
          value: "production"

  - it: should not have annotations when not specified
    set:
      persistence.enabled: true
    asserts:
      - isNull:
          path: metadata.annotations