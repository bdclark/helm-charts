suite: test pvc
templates:
  - pvc.yaml
tests:
  - it: should create both PVCs with default values
    asserts:
      - hasDocuments:
          count: 2

  - it: should create config PVC with default values
    documentIndex: 0
    asserts:
      - isKind:
          of: PersistentVolumeClaim
      - equal:
          path: metadata.name
          value: RELEASE-NAME-sonarr-config
      - equal:
          path: spec.accessModes[0]
          value: ReadWriteOnce
      - equal:
          path: spec.resources.requests.storage
          value: 1Gi

  - it: should create data PVC with default values
    documentIndex: 1
    asserts:
      - isKind:
          of: PersistentVolumeClaim
      - equal:
          path: metadata.name
          value: RELEASE-NAME-sonarr-data
      - equal:
          path: spec.accessModes[0]
          value: ReadWriteOnce
      - equal:
          path: spec.resources.requests.storage
          value: 100Gi

  - it: should NOT create config PVC when disabled
    set:
      persistence.config.enabled: false
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: metadata.name
          value: RELEASE-NAME-sonarr-data

  - it: should NOT create data PVC when disabled
    set:
      persistence.data.enabled: false
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: metadata.name
          value: RELEASE-NAME-sonarr-config

  - it: should NOT create any PVC when both disabled
    set:
      persistence.config.enabled: false
      persistence.data.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should NOT create config PVC when using existing claim
    set:
      persistence.config.enabled: true
      persistence.config.existingClaim: my-existing-config
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: metadata.name
          value: RELEASE-NAME-sonarr-data

  - it: should NOT create data PVC when using existing claim
    set:
      persistence.data.enabled: true
      persistence.data.existingClaim: my-existing-data
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: metadata.name
          value: RELEASE-NAME-sonarr-config

  - it: should use custom storage size for config
    set:
      persistence.config.size: 5Gi
    documentIndex: 0
    asserts:
      - equal:
          path: spec.resources.requests.storage
          value: 5Gi

  - it: should use custom storage size for data
    set:
      persistence.data.size: 500Gi
    documentIndex: 1
    asserts:
      - equal:
          path: spec.resources.requests.storage
          value: 500Gi

  - it: should use custom storage class for config
    set:
      persistence.config.storageClass: fast-ssd
    documentIndex: 0
    asserts:
      - equal:
          path: spec.storageClassName
          value: fast-ssd

  - it: should use custom storage class for data
    set:
      persistence.data.storageClass: bulk-storage
    documentIndex: 1
    asserts:
      - equal:
          path: spec.storageClassName
          value: bulk-storage

  - it: should disable storage class when set to "-" for config
    set:
      persistence.config.storageClass: "-"
    documentIndex: 0
    asserts:
      - equal:
          path: spec.storageClassName
          value: ""

  - it: should disable storage class when set to "-" for data
    set:
      persistence.data.storageClass: "-"
    documentIndex: 1
    asserts:
      - equal:
          path: spec.storageClassName
          value: ""

  - it: should use custom access modes for config
    set:
      persistence.config.accessModes:
        - ReadWriteMany
    documentIndex: 0
    asserts:
      - equal:
          path: spec.accessModes[0]
          value: ReadWriteMany

  - it: should use custom access modes for data
    set:
      persistence.data.accessModes:
        - ReadWriteMany
        - ReadOnlyMany
    documentIndex: 1
    asserts:
      - equal:
          path: spec.accessModes[0]
          value: ReadWriteMany
      - equal:
          path: spec.accessModes[1]
          value: ReadOnlyMany

  - it: should apply annotations to config PVC
    set:
      persistence.config.annotations:
        k8up.io/backup: "true"
    documentIndex: 0
    asserts:
      - equal:
          path: metadata.annotations["k8up.io/backup"]
          value: "true"

  - it: should apply annotations to data PVC
    set:
      persistence.data.annotations:
        backup.volume.io/backup: "true"
    documentIndex: 1
    asserts:
      - equal:
          path: metadata.annotations["backup.volume.io/backup"]
          value: "true"
