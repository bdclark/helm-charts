name: Release Charts

on:
  workflow_run:
    workflows: [CI]
    branches: [main]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Load versions
        id: versions
        run: |
          while IFS='=' read -r key value; do
            [[ -z "$key" || "$key" =~ ^# ]] && continue
            echo "${key}=${value}" >> "$GITHUB_OUTPUT"
          done < .github/versions.env

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ steps.versions.outputs.HELM_VERSION }}

      - name: Add helm repositories
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo add stable https://charts.helm.sh/stable
          helm repo update

      - name: Detect charts to release
        id: detect
        run: |
          charts_to_release=""
          for chart_dir in charts/*/; do
            chart=$(basename "$chart_dir")
            version=$(awk '/^version:/ {print $2; exit}' "$chart_dir/Chart.yaml")
            tag="${chart}-${version}"
            if git rev-parse -q --verify "refs/tags/$tag" >/dev/null 2>&1; then
              echo "Skip: $chart v$version (already released)"
            else
              echo "Release: $chart v$version"
              charts_to_release="${charts_to_release}${chart}"$'\n'
            fi
          done

          if [[ -n "$charts_to_release" ]]; then
            echo "release=true" >> "$GITHUB_OUTPUT"
            echo "$charts_to_release" | grep -v '^$' > charts-to-release.txt
          else
            echo "release=false" >> "$GITHUB_OUTPUT"
            echo "No charts to release"
          fi

      - name: Build chart dependencies
        if: steps.detect.outputs.release == 'true'
        run: |
          while read -r chart; do
            helm dependency build "charts/$chart"
          done < charts-to-release.txt

      - name: Create gh-pages branch if needed
        if: steps.detect.outputs.release == 'true'
        run: |
          if ! git ls-remote --exit-code --heads origin gh-pages >/dev/null 2>&1; then
            git checkout --orphan gh-pages
            git rm -rf .
            echo "# Helm Charts" > README.md
            git add README.md
            git commit -m "Initialize gh-pages"
            git push origin gh-pages
            git checkout -
          fi

      - name: Run chart-releaser
        if: steps.detect.outputs.release == 'true'
        uses: helm/chart-releaser-action@v1
        with:
          config: cr.yaml
        env:
          CR_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Push to OCI registry
        if: steps.detect.outputs.release == 'true'
        env:
          OCI_REGISTRY: ghcr.io/${{ github.repository_owner }}/helm-charts
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u "${{ github.actor }}" --password-stdin

          while read -r chart; do
            pkg=$(ls .cr-release-packages/${chart}-*.tgz 2>/dev/null | head -1)
            if [[ -n "$pkg" ]]; then
              echo "Pushing $pkg to oci://$OCI_REGISTRY"
              helm push "$pkg" "oci://$OCI_REGISTRY"
            fi
          done < charts-to-release.txt

      - name: Update gh-pages assets
        if: steps.detect.outputs.release == 'true'
        run: |
          git fetch origin gh-pages
          git worktree add gh-pages-branch gh-pages

          [[ -f index.html ]] && cp index.html gh-pages-branch/
          [[ -f artifacthub-repo.yml ]] && cp artifacthub-repo.yml gh-pages-branch/

          cd gh-pages-branch
          git add -A
          if ! git diff --staged --quiet; then
            git commit -m "Update gh-pages assets"
            git push origin gh-pages
          fi

          cd ..
          git worktree remove gh-pages-branch
