name: Integration Tests

on:
  pull_request:
    paths:
      - 'charts/**'
      - 'tests/integration/**'
  push:
    branches:
      - main
      - develop
    paths:
      - 'charts/**'
      - 'tests/integration/**'
  workflow_dispatch:
    inputs:
      charts:
        description: 'Charts to test (comma-separated, or "all")'
        required: false
        default: 'all'

permissions:
  contents: read

jobs:
  # Detect which charts have changed
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      charts: ${{ steps.list.outputs.charts }}
      changed: ${{ steps.list.outputs.changed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.8.0

      - name: List changed charts
        id: list
        run: |
          # Get changed charts from ct
          target_branch="${{ github.event.repository.default_branch }}"
          git fetch origin "$target_branch" --depth=1
          changed_charts=$(ct list-changed --target-branch "$target_branch" --print-config=false)

          # Handle workflow_dispatch input
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.charts }}" = "all" ]; then
              changed_charts=$(find charts -name Chart.yaml -exec dirname {} \; | sed 's|charts/||' | sort)
            else
              changed_charts="${{ github.event.inputs.charts }}"
            fi
          else
            changed_charts=$(echo "$changed_charts" | sed 's|^charts/||')
          fi

          if [ -z "$changed_charts" ]; then
            diff_files=$(git diff --name-only "origin/$target_branch"...HEAD | grep '^tests/integration/' || true)
            if [ -n "$diff_files" ]; then
              inferred=$(echo "$diff_files" | sed -n 's|tests/integration/pytest_suite/charts/test_\([^/]*\)\.py|\1|p' | sort -u)
              if [ -z "$inferred" ]; then
                inferred=$(find charts -name Chart.yaml -exec dirname {} \; | sed 's|charts/||' | sort)
              fi
              changed_charts="$inferred"
            fi
          fi

          # Convert to JSON array and check if any changes
          if [ -n "$changed_charts" ]; then
            charts_json=$(echo "$changed_charts" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "charts=$charts_json" >> $GITHUB_OUTPUT
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changed charts: $charts_json"
          else
            echo "charts=[]" >> $GITHUB_OUTPUT
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No charts changed"
          fi

  # Run integration tests for each changed chart
  integration-test:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.changed == 'true'
    strategy:
      matrix:
        chart: ${{ fromJson(needs.detect-changes.outputs.charts) }}
      fail-fast: false  # Continue testing other charts even if one fails

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.14'
          check-latest: true

      - name: Cache Python virtualenv
        uses: actions/cache@v4
        with:
          path: .venv
          key: ${{ runner.os }}-venv-${{ hashFiles('tests/integration/pytest_suite/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-venv-

      - name: Cache kind image
        uses: actions/cache@v4
        with:
          path: ~/.cache/kind
          key: ${{ runner.os }}-kind-v1.30.0
          restore-keys: |
            ${{ runner.os }}-kind-

      - name: Set up Helm
        uses: azure/setup-helm@v4.2.0
        with:
          version: v3.14.0

      - name: Create kind cluster
        uses: helm/kind-action@v1.10.0
        with:
          wait: 120s
          node_image: kindest/node:v1.30.0

      - name: Wait for cluster to be ready
        run: |
          kubectl cluster-info
          kubectl wait --for=condition=ready nodes --all --timeout=300s
          kubectl get nodes -o wide

      - name: Prepare Python environment
        run: |
          if [ ! -d ".venv" ]; then
            python -m venv .venv
          fi
          . .venv/bin/activate
          pip install --upgrade pip
          pip install -r tests/integration/pytest_suite/requirements.txt

      - name: Check if pytest suite exists
        id: pytest-check
        run: |
          test_file="tests/integration/pytest_suite/charts/test_${{ matrix.chart }}.py"
          if [ -f "$test_file" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "Pytest suite found for ${{ matrix.chart }}"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "No pytest suite found for ${{ matrix.chart }}"
          fi

      - name: Run pytest integration suite
        if: steps.pytest-check.outputs.exists == 'true'
        run: |
          . .venv/bin/activate
          pytest tests/integration/pytest_suite/charts/test_${{ matrix.chart }}.py
        timeout-minutes: 20

      - name: Debug on failure
        if: failure() && steps.check-test.outputs.exists == 'true'
        run: |
          echo "=== DEBUGGING INTEGRATION TEST FAILURE ==="
          echo "Chart: ${{ matrix.chart }}"
          echo "Namespace: ${{ matrix.chart }}-integration-test"

          echo "=== CLUSTER STATE ==="
          kubectl get nodes -o wide || true
          kubectl get pods -A -o wide || true
          kubectl get svc -A || true
          kubectl get pvc -A || true

          echo "=== CHART PODS ==="
          kubectl get pods -n "${{ matrix.chart }}-integration-test" -o wide || true

          echo "=== CHART LOGS ==="
          kubectl logs -n "${{ matrix.chart }}-integration-test" --selector="app.kubernetes.io/name=${{ matrix.chart }}" --tail=50 || true

          echo "=== EVENTS ==="
          kubectl get events -n "${{ matrix.chart }}-integration-test" --sort-by='.lastTimestamp' || true

      - name: Cleanup kind cluster
        if: always()
        run: kind delete cluster --name chart-testing || true

  # Summary job that depends on all integration tests
  integration-summary:
    runs-on: ubuntu-latest
    needs: [detect-changes, integration-test]
    if: always() && needs.detect-changes.outputs.changed == 'true'
    steps:
      - name: Check integration test results
        run: |
          echo "=== INTEGRATION TEST SUMMARY ==="
          if [ "${{ needs.integration-test.result }}" = "success" ]; then
            echo "✅ All integration tests passed!"
            echo "Charts tested: ${{ needs.detect-changes.outputs.charts }}"
          elif [ "${{ needs.integration-test.result }}" = "failure" ]; then
            echo "❌ Some integration tests failed"
            echo "Charts tested: ${{ needs.detect-changes.outputs.charts }}"
            echo "Check the individual job results above for details"
            exit 1
          elif [ "${{ needs.integration-test.result }}" = "skipped" ]; then
            echo "⏭️ Integration tests were skipped"
            echo "Reason: No charts with integration tests were changed"
          else
            echo "⚠️ Integration tests completed with status: ${{ needs.integration-test.result }}"
          fi
