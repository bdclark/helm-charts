name: CI

on:
  pull_request:
    paths:
      - "charts/**"
      - ".github/workflows/ci.yaml"
      - ".github/versions.env"
      - "ct.yaml"
  push:
    branches:
      - main
    paths:
      - "charts/**"
      - ".github/workflows/ci.yaml"
      - ".github/versions.env"
      - "ct.yaml"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  load-versions:
    name: Load Versions
    runs-on: ubuntu-latest
    outputs:
      helm: ${{ steps.versions.outputs.HELM_VERSION }}
      helm-unittest: ${{ steps.versions.outputs.HELM_UNITTEST_VERSION }}
      kubeconform: ${{ steps.versions.outputs.KUBECONFORM_VERSION }}
      helm-docs: ${{ steps.versions.outputs.HELM_DOCS_VERSION }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          sparse-checkout: .github/versions.env
          sparse-checkout-cone-mode: false

      - name: Parse versions.env
        id: versions
        run: |
          while IFS='=' read -r key value; do
            [[ -z "$key" || "$key" =~ ^# ]] && continue
            echo "${key}=${value}" >> "$GITHUB_OUTPUT"
          done < .github/versions.env

  docs:
    name: Docs
    runs-on: ubuntu-latest
    needs: load-versions
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install helm-docs
        run: |
          VERSION="${{ needs.load-versions.outputs.helm-docs }}"
          VERSION="${VERSION#v}"
          curl -sSL "https://github.com/norwoodj/helm-docs/releases/download/v${VERSION}/helm-docs_${VERSION}_Linux_x86_64.tar.gz" | tar xz
          sudo mv helm-docs /usr/local/bin/

      - name: Run helm-docs
        run: helm-docs --sort-values-order file

      - name: Check for changes
        run: |
          if ! git diff --exit-code; then
            echo "::error::Documentation is out of date. Run 'helm-docs' locally and commit the changes."
            exit 1
          fi

  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.detect.outputs.changed }}
      charts: ${{ steps.detect.outputs.charts }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2

      - name: Detect changed charts
        id: detect
        run: |
          changed=$(ct list-changed --target-branch ${{ github.event.repository.default_branch }})
          if [[ -z "$changed" ]]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "charts=[]" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            charts=$(echo "$changed" | sed 's|^charts/||' | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "charts=$charts" >> "$GITHUB_OUTPUT"
            echo "Changed charts: $charts"
          fi

  chart-test:
    name: Test ${{ matrix.chart }}
    runs-on: ubuntu-latest
    needs: [load-versions, detect-changes]
    if: needs.detect-changes.outputs.changed == 'true'
    strategy:
      fail-fast: false
      matrix:
        chart: ${{ fromJson(needs.detect-changes.outputs.charts) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ needs.load-versions.outputs.helm }}

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2

      - name: Add helm repositories
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update

      - name: Run ct lint
        run: ct lint --charts charts/${{ matrix.chart }}

      - name: Install helm-unittest
        run: helm plugin install https://github.com/helm-unittest/helm-unittest --version ${{ needs.load-versions.outputs.helm-unittest }}

      - name: Run helm unittest
        run: helm unittest charts/${{ matrix.chart }}

      - name: Install kubeconform
        run: |
          VERSION="${{ needs.load-versions.outputs.kubeconform }}"
          VERSION="${VERSION#v}"
          curl -sSL "https://github.com/yannh/kubeconform/releases/download/v${VERSION}/kubeconform-linux-amd64.tar.gz" | tar xz
          sudo mv kubeconform /usr/local/bin/

      - name: Run kubeconform
        run: |
          helm template test charts/${{ matrix.chart }} | kubeconform -strict -ignore-missing-schemas -summary
