name: CI

on:
  pull_request:
    paths:
      - 'charts/**'
      - 'tests/**'
      - '.github/workflows/**'
      - 'Taskfile.yml'
      - 'ct.yaml'
      - 'scripts/**'
  push:
    branches:
      - main
      - develop
    paths:
      - 'charts/**'
      - 'tests/**'
      - '.github/workflows/**'
      - 'Taskfile.yml'
      - 'ct.yaml'
      - 'scripts/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  detect-charts:
    name: Detect Changed Charts
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.collect.outputs.changed }}
      charts_json: ${{ steps.collect.outputs.charts_json }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.6.1

      - name: List changed charts
        id: collect
        run: |
          set -eo pipefail
          target_branch="${{ github.event.repository.default_branch }}"
          changed_charts=$(ct list-changed --target-branch "$target_branch" --print-config=false || true)

          if [ -z "$changed_charts" ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "charts_json=[]" >> "$GITHUB_OUTPUT"
            : > changed-charts.txt
            exit 0
          fi

          normalized_charts=$(echo "$changed_charts" | sed 's|^charts/||')
          charts_json=$(echo "$normalized_charts" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "changed=true" >> "$GITHUB_OUTPUT"
          echo "charts_json=$charts_json" >> "$GITHUB_OUTPUT"
          printf "%s\n" "$normalized_charts" > changed-charts.txt

      - name: Upload changed chart list
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: changed-charts
          path: changed-charts.txt

  static-checks:
    name: Static Checks
    runs-on: ubuntu-latest
    needs: detect-charts
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          check-latest: true

      - name: Install yamllint
        run: pip install yamllint

      - name: Run yamllint
        run: yamllint charts

  chart-verification:
    name: Chart Verification
    runs-on: ubuntu-latest
    needs: detect-charts
    if: needs.detect-charts.outputs.changed == 'true'
    strategy:
      fail-fast: false
      matrix:
        chart: ${{ fromJson(needs.detect-charts.outputs.charts_json) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4.2.0
        with:
          version: v3.14.0

      - name: Install helm-unittest plugin
        run: |
          if ! helm plugin list | grep -q "unittest"; then
            helm plugin install https://github.com/helm-unittest/helm-unittest --version v0.3.5
          fi

      - name: Install kubeconform
        run: |
          set -euo pipefail
          VERSION="0.6.7"
          curl -L -o kubeconform.tar.gz "https://github.com/yannh/kubeconform/releases/download/v${VERSION}/kubeconform-linux-amd64.tar.gz"
          tar -xzf kubeconform.tar.gz
          mkdir -p "$HOME/bin"
          mv kubeconform "$HOME/bin/kubeconform"
          chmod +x "$HOME/bin/kubeconform"
          echo "$HOME/bin" >> "$GITHUB_PATH"

      - name: Add helm repositories
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo add stable https://charts.helm.sh/stable
          helm repo update

      - name: Build chart dependencies
        run: helm dependency build charts/${{ matrix.chart }}

      - name: Helm lint
        run: helm lint charts/${{ matrix.chart }}

      - name: Helm unittest
        run: helm unittest charts/${{ matrix.chart }}

      - name: Kubeconform validation
        run: |
          set -eo pipefail
          helm template ci-${{ matrix.chart }} charts/${{ matrix.chart }} \
            --namespace ci-${{ matrix.chart }} \
            | kubeconform -strict -ignore-missing-schemas -summary
